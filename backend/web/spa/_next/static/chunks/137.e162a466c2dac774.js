"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[137],{8137:(e,t,a)=>{a.d(t,{convertToRgb565Zip:()=>g});let n=null;async function i(){if(n)return n;let{FFmpeg:e}=await a.e(654).then(a.bind(a,5654));return n=e}async function o(){let e=new(await i());return await e.load({corePath:"/ffmpeg/umd/ffmpeg-core.js",log:!0}),e}var l=a(9311),r=a.n(l);async function c(e,t,a){var n,i,o,l,r,c;null===(n=a.onProgress)||void 0===n||n.call(a,0,"resizing"),null===(i=a.onLog)||void 0===i||i.call(a,"Starting video optimization...");let g=e=>{var t;let{progress:n}=e;null===(t=a.onProgress)||void 0===t||t.call(a,15*n,"resizing")},s=e=>{let{message:t}=e};e.on("progress",g),e.on("log",s);let f="scale=".concat(320,":").concat(240,":force_original_aspect_ratio=increase,crop=").concat(320,":").concat(240,",fps=").concat(25);await e.exec(["-i",t,"-vf",f,"-c:v","mpeg4","-q:v","8","-an","-y","optimized.mp4"]),e.off("progress",g),e.off("log",s),null===(o=a.onProgress)||void 0===o||o.call(a,15,"resizing"),null===(l=a.onLog)||void 0===l||l.call(a,"Video optimization complete");try{await e.deleteFile(t),null===(r=a.onLog)||void 0===r||r.call(a,"Deleted original ".concat(t," from MEMFS after optimization"))}catch(e){null===(c=a.onLog)||void 0===c||c.call(a,"Warning: Could not delete ".concat(t,": ").concat(e))}}async function g(e){var t,a,n,i,l,g,s,f,d,u,p,w,m,v;let y,b,h=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_=arguments.length>2?arguments[2]:void 0,x="input_media";if(_)y=_;else{let t=await e.arrayBuffer(),a=Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("").slice(0,16),n=e.name.replace(/\.[^.]+$/,"").replace(/\s+/g,"_").toLowerCase();y="".concat(n,"_").concat(a)}let F=e.type.startsWith("image/")||e.name.toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp|webp)$/),L=new Uint8Array(await e.arrayBuffer());if(F){let i=await o();await i.writeFile(x,L),null===(t=h.onProgress)||void 0===t||t.call(h,0,"converting");let l="output.raw";await i.exec(["-i",x,"-vf","scale=".concat(320,":").concat(240,":force_original_aspect_ratio=increase,crop=").concat(320,":").concat(240),"-f","rawvideo","-pix_fmt","rgb565be","-vframes","1",l]);let c=await i.readFile(l);b=1,await i.deleteFile(l),null===(a=h.onProgress)||void 0===a||a.call(h,90,"converting");let g=new(r()),s=new Uint8Array(8+c.length),f=new DataView(s.buffer);f.setUint32(0,b,!1),f.setUint32(4,153600,!1),s.set(c,8),g.file("frames.bin",s);let d={slug:y,original_filename:e.name,type:"image",width:320,height:240,frame_count:b,format:"rgb565",fps:0};if(g.file("metadata.json",JSON.stringify(d)),"function"==typeof i.exit)try{await i.exit()}catch(e){}return null===(n=h.onProgress)||void 0===n||n.call(h,100,"converting"),{slug:y,blob:await g.generateAsync({type:"blob"})}}{let t;let a=await o();await a.writeFile(x,L),L=null,await c(a,x,h),null===(i=h.onProgress)||void 0===i||i.call(h,15,"converting"),null===(l=h.onLog)||void 0===l||l.call(h,"Starting streaming frame extraction..."),a.on("log",e=>{var t;let{message:a}=e;null===(t=h.onLog)||void 0===t||t.call(h,a)});let n="all_frames.bin";null===(g=h.onLog)||void 0===g||g.call(h,"Extracting all frames to single binary file...");try{await a.exec(["-i","optimized.mp4","-an","-pix_fmt","rgb565be","-c:v","rawvideo","-f","rawvideo",n])}catch(e){if(!String(e||"").includes("Aborted"))throw e}try{t=await a.readFile(n),null===(p=h.onLog)||void 0===p||p.call(h,"Binary extraction complete: ".concat(t.length," bytes"))}catch(e){throw null===(w=h.onLog)||void 0===w||w.call(h,"Failed to read binary output: ".concat(e)),Error("FFmpeg failed to generate binary frame data")}if(0===(b=Math.floor(t.length/153600)))throw Error("No frames extracted - binary file size: ".concat(t.length," bytes"));null===(s=h.onProgress)||void 0===s||s.call(h,80,"converting"),null===(f=h.onLog)||void 0===f||f.call(h,"Extracted ".concat(b," frames (").concat(t.length," bytes)"));let _=new Uint8Array(8+t.length),F=new DataView(_.buffer);F.setUint32(0,b,!1),F.setUint32(4,153600,!1),_.set(t,8),null===(d=h.onProgress)||void 0===d||d.call(h,90,"converting");let P=new(r());P.file("frames.bin",_);let A={slug:y,original_filename:e.name,type:"video",width:320,height:240,frame_count:b,format:"rgb565",fps:25};P.file("metadata.json",JSON.stringify(A));let S=await P.generateAsync({type:"blob"});if(null===(u=h.onProgress)||void 0===u||u.call(h,100,"converting"),"function"==typeof a.exit)try{await a.exit(),null===(m=h.onLog)||void 0===m||m.call(h,"FFmpeg WASM heap released")}catch(e){null===(v=h.onLog)||void 0===v||v.call(h,"Warning: FFmpeg cleanup failed: ".concat(e))}return{slug:y,blob:S}}}}}]);