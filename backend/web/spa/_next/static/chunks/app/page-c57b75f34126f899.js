(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1886:(e,t,a)=>{"use strict";a.d(t,{KG:()=>D,Px:()=>C,S:()=>j,Uk:()=>T,Ux:()=>k,YB:()=>b,ZW:()=>S,eB:()=>g,eW:()=>w,forceStopProgress:()=>N,hR:()=>h,ij:()=>x,jq:()=>v,sd:()=>y,w8:()=>m});var n=a(6671);let r="/api";class s{set(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3e4;this.cache.set(e,{data:t,timestamp:Date.now(),ttl:a})}get(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),null):t.data:null}invalidate(e){this.cache.delete(e)}clear(){this.cache.clear()}constructor(){this.cache=new Map}}let o=new s;async function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,n=Error("No attempts made");for(let l=0;l<=t;l++)try{return await e()}catch(i){var r,s,o;if(n=i,!((null===(r=i.message)||void 0===r?void 0:r.includes("503"))||(null===(s=i.message)||void 0===s?void 0:s.includes("Service Unavailable"))||(null===(o=i.message)||void 0===o?void 0:o.includes("Failed to fetch"))||"AbortError"===i.name)||l===t)throw i;let e=a*Math.pow(2,l)+500*Math.random();console.log("API retry ".concat(l+1,"/").concat(t," after ").concat(e,"ms: ").concat(i.message)),await new Promise(t=>setTimeout(t,e))}throw n}async function i(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=()=>fetch(e,t);return a?n():l(n)}async function c(e){if(!e.ok){let t;try{let a=e.headers.get("content-type");if(a&&a.includes("application/json")){let a=await e.json();t=a.message||a.error||"HTTP ".concat(e.status)}else t=await e.text()}catch(a){t="HTTP ".concat(e.status,": ").concat(e.statusText)}throw Error(t)}let t=e.headers.get("content-type");if(t&&t.includes("application/json"))return e.json();throw Error("Expected JSON response but received HTML")}function d(e){if(!e.success)throw Error(e.message||"API request failed");return e.data}class u{async get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return c(await i("".concat(this.baseUrl).concat(e),{...t,method:"GET"}))}async post(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={...a,method:"POST",headers:{"Content-Type":"application/json",...a.headers}};return t&&(n.body=t instanceof FormData?t:JSON.stringify(t),t instanceof FormData&&n.headers&&delete n.headers["Content-Type"]),c(await i("".concat(this.baseUrl).concat(e),n))}async put(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return c(await i("".concat(this.baseUrl).concat(e),{...a,method:"PUT",headers:{"Content-Type":"application/json",...a.headers},body:t?JSON.stringify(t):void 0}))}async delete(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return c(await i("".concat(this.baseUrl).concat(e),{...t,method:"DELETE"}))}async upload(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return c(await i("".concat(this.baseUrl).concat(e),{...a,method:"POST",body:t},!0))}constructor(e=r){this.baseUrl=e}}let f=new u;async function g(){return d(await f.get("/poll/progress"))}function p(e,t,a){return n.o.promise(e,{loading:t,success:a||"Operation completed",error:e=>"Error: ".concat(e.message)}),e}async function m(e){let t=p(f.delete("/media/".concat(e)).then(d),"Deleting media...","Media deleted");return T(),t}async function h(e){let t=p(f.post("/loop",{slug:e}).then(d),"Adding to loop...","Added to loop");return T(),t}async function v(e){let t=p(f.delete("/loop/".concat(e)).then(d),"Removing from loop...","Removed from loop");return T(),t}async function x(e){let t=p(f.put("/loop",{loop:e}).then(d),"Saving order…","Loop order saved");return T(),t}async function y(){return p(f.post("/playback/toggle").then(d),"Toggling playback...")}async function b(){return p(f.post("/playback/next").then(d),"Skipping to next...")}async function w(){return p(f.post("/playback/previous").then(d),"Skipping to previous...")}async function j(){return p(f.post("/playback/loop-mode").then(d),"Toggling loop mode...")}async function N(){return f.post("/playback/force-stop-progress").then(d)}async function k(){return d(await p(f.get("/updates/check"),"Checking for updates..."))}async function C(){return p(f.post("/updates/install").then(d),"Installing update...","Update installed successfully")}async function S(e){if(!(null==e?void 0:e.signal)&&U)return console.log("Dashboard request already in flight, returning existing promise"),U;if(U&&!(null==e?void 0:e.signal))return U;console.log("Starting new dashboard request");let t=Date.now(),a=f.get("/dashboard",{...e,signal:(null==e?void 0:e.signal)||AbortSignal.timeout(6e4)}).finally(()=>{let e=Date.now()-t;console.log("Dashboard request completed in ".concat(e,"ms")),U=null});U=a;try{return await a}catch(e){throw U=null,e}}function T(){o.invalidate("dashboard")}let U=null;async function D(e,t,a){console.log("Starting upload of processed media: ".concat(t));let n=e instanceof FormData?e:(()=>{let a=new FormData;return a.append("files",e,t),a})(),s=new XMLHttpRequest;return new Promise((e,o)=>{s.open("POST","".concat(r,"/media")),console.log("XHR request opened for ".concat(t)),s.onload=()=>{var a;if(console.log("XHR onload fired for ".concat(t,": status ").concat(s.status,", readyState ").concat(s.readyState)),console.log("Response received: ".concat((null===(a=s.responseText)||void 0===a?void 0:a.length)||0," bytes")),s.status>=200&&s.status<300)try{let a=JSON.parse(s.responseText||"{}");console.log("Upload successful for ".concat(t,":"),a),e(d(a))}catch(e){console.error("Failed to parse response for ".concat(t,":"),e),console.error("Raw response: ".concat(s.responseText)),o(Error("Invalid response format: ".concat(e)))}else console.error("Upload failed for ".concat(t,": HTTP ").concat(s.status)),console.error("Error response: ".concat(s.responseText)),o(Error("Upload failed: HTTP ".concat(s.status)))},s.onerror=e=>{console.error("XHR error for ".concat(t,":"),e),console.error("XHR state: status=".concat(s.status,", readyState=").concat(s.readyState)),o(Error("Network error during upload"))},s.onabort=()=>{console.warn("XHR aborted for ".concat(t)),o(Error("Upload aborted"))},s.ontimeout=()=>{console.error("XHR timeout for ".concat(t)),o(Error("Upload timeout"))},s.upload&&a&&(s.upload.onloadstart=()=>{console.log("Upload started for ".concat(t))},s.upload.onprogress=e=>{if(e.lengthComputable){let n=e.loaded/e.total;console.log("Upload progress for ".concat(t,": ").concat((100*n).toFixed(1),"% (").concat(e.loaded,"/").concat(e.total," bytes)")),a(n)}else console.log("Upload progress for ".concat(t,": ").concat(e.loaded," bytes (total unknown)"))},s.upload.onload=()=>{console.log("File transfer complete for ".concat(t," - backend processing starting..."))},s.upload.onerror=e=>{console.error("Upload error for ".concat(t,":"),e)},s.upload.onabort=()=>{console.warn("Upload aborted for ".concat(t))},s.upload.ontimeout=()=>{console.error("Upload timeout for ".concat(t))}),s.timeout=9e5,console.log("Sending XHR request for ".concat(t,"..."));try{s.send(n),console.log("XHR send() called for ".concat(t))}catch(e){console.error("Failed to send XHR for ".concat(t,":"),e),o(e)}})}},2857:(e,t,a)=>{Promise.resolve().then(a.bind(a,5379))},5379:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>X});var n=a(5155),r=a(2115),s=a(5863),o=a(2596),l=a(9688);function i(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,l.QP)((0,o.$)(t))}r.forwardRef((e,t)=>{let{className:a,value:r,...o}=e;return(0,n.jsx)(s.bL,{ref:t,className:i("relative h-4 w-full overflow-hidden rounded-full bg-secondary",a),...o,children:(0,n.jsx)(s.C1,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:"translateX(-".concat(100-(r||0),"%)")}})})}).displayName=s.bL.displayName;var c=a(1886);class d{async startUpload(e){let t;let a=await e.arrayBuffer();try{var n,r;if(null===(r=crypto)||void 0===r?void 0:null===(n=r.subtle)||void 0===n?void 0:n.digest)t=await crypto.subtle.digest("SHA-256",a);else throw Error("Web Crypto API not available")}catch(n){console.warn("Web Crypto API not available, using fallback hash:",n),t=this.createFallbackHash(e,a)}let s=Array.from(new Uint8Array(t)).map(e=>e.toString(16).padStart(2,"0")).join("").slice(0,16),o=e.name.replace(/\.[^.]+$/,"").replace(/\s+/g,"_").toLowerCase(),l="".concat(o,"_").concat(s),i="upload_".concat(l);if(this.transactions.has(i)){let t=this.transactions.get(i);if("error"!==t.state&&"cancelled"!==t.state)throw console.warn("Blocking duplicate upload: ".concat(e.name," (ID: ").concat(i,")")),Error("Upload already in progress: ".concat(e.name));console.log("Replacing failed upload transaction: ".concat(i)),this.cleanupTransaction(i)}if(Array.from(this.transactions.values()).find(t=>t.filename===e.name&&"error"!==t.state&&"cancelled"!==t.state&&"complete"!==t.state))throw console.warn("Blocking duplicate upload by filename: ".concat(e.name)),Error("Upload already in progress: ".concat(e.name));let c={id:i,filename:e.name,originalFile:e,state:"pending",progress:0,stage:"queued",createdAt:Date.now(),expectedSlug:l};return this.transactions.set(i,c),this.persistTransaction(c),this.emit(c,"queued",0,"Upload queued"),this.activeCount<this.maxConcurrent&&this.processTransaction(i),i}createFallbackHash(e,t){let a=new Uint8Array(t),n=0;for(let t=0;t<e.name.length;t++)n=31*n+e.name.charCodeAt(t)&0xffffffff;n=31*n+e.size&0xffffffff;for(let t=0;t<e.type.length;t++)n=31*n+e.type.charCodeAt(t)&0xffffffff;let r=Math.min(1024,a.length),s=Math.max(1,Math.floor(a.length/r));for(let e=0;e<a.length;e+=s)n=31*n+a[e]&0xffffffff;let o=new ArrayBuffer(32),l=new DataView(o);for(let e=0;e<8;e++)l.setUint32(4*e,n+31*e,!1);return o}async processTransaction(e){let t=this.transactions.get(e);if(t){this.activeCount++;try{await this.processFile(t),await this.uploadFiles(t),await this.waitForCompletion(t),this.updateTransaction(t,"complete",100,"Upload complete")}catch(r){let n=r instanceof Error?r.message:String(r);this.updateTransaction(t,"error",0,n),console.error("Upload failed [".concat(e,"]:"),r);try{let{forceStopProgress:e}=await Promise.resolve().then(a.bind(a,1886));await e(),console.log("Force stopped backend progress display after upload failure")}catch(e){console.warn("Failed to force stop backend progress:",e)}}finally{this.cleanupTransaction(e),this.activeCount--,this.processNextQueued()}}}async processFile(e){if(!e.originalFile)throw Error("Original file not available for processing");this.updateTransaction(e,"processing",0,"Starting conversion...");let t=e.originalFile;if("image/svg+xml"===e.originalFile.type||e.originalFile.name.toLowerCase().endsWith(".svg")){this.updateTransaction(e,"processing",5,"Converting SVG to PNG...");let{convertSvgToRgb565Zip:t}=await a.e(405).then(a.bind(a,9405));try{let a=await t(e.originalFile,{onProgress:(t,a)=>{let n=Math.min(.4*t,40);this.updateTransaction(e,"processing",n,this.getStageMessage(a))}},e.expectedSlug);e.zipBlob=a.blob;return}catch(t){let e=t instanceof Error?t.message:String(t);throw Error("SVG conversion failed: ".concat(e))}}return new Promise((n,r)=>{let s=new Worker(a.tu(new URL(a.p+a.u(158),a.b)));this.workers.set(e.id,s),s.addEventListener("message",t=>{let{id:a,progress:o,stage:l,done:i,blob:c,error:d}=t.data;if(a===e.id){if(d){s.terminate(),this.workers.delete(e.id),r(Error(d));return}if("number"==typeof o&&l){let t=Math.min(.4*o,40);this.updateTransaction(e,"processing",t,this.getStageMessage(l))}i&&c&&(e.zipBlob=c,s.terminate(),this.workers.delete(e.id),n())}}),s.postMessage({id:e.id,file:t,expectedSlug:e.expectedSlug}),setTimeout(()=>{this.workers.has(e.id)&&(s.terminate(),this.workers.delete(e.id),r(Error("Processing timeout")))},3e5)})}async uploadFiles(e){if(!e.zipBlob)throw Error("ZIP blob not available");if(!e.originalFile)throw Error("Original file not available for upload");this.updateTransaction(e,"uploading",40,"Uploading files...");let t=new FormData;t.append("files",e.originalFile,e.filename),t.append("files",e.zipBlob,"".concat(this.getBasename(e.filename),"_frames.zip"));let a=await (0,c.KG)(t,"".concat(e.filename," + frames"),t=>{this.updateTransaction(e,"uploading",40+20*t,"Uploading files...")});e.uploadResult=a}async waitForCompletion(e){return this.updateTransaction(e,"finalizing",60,"Processing on device..."),new Promise(t=>{let a=setTimeout(()=>{console.warn("Timeout waiting for completion: ".concat(e.filename)),t()},3e4);e.completionCallback=()=>{clearTimeout(a),t()}})}updateTransaction(e,t,a,n){e.state=t,e.progress=Math.round(a),e.stage=n,this.persistTransaction(e),this.emit(e,n,a)}emit(e,t,a,n){let r={transaction:{...e},stage:t,progress:a,message:n};this.listeners.forEach(e=>{try{e(r)}catch(e){console.error("Upload progress listener error:",e)}})}cleanupTransaction(e){console.log("Cleaning up transaction: ".concat(e));let t=this.workers.get(e);t&&(t.terminate(),this.workers.delete(e));let a=this.transactions.get(e);a&&a.completionCallback&&delete a.completionCallback,setTimeout(()=>{this.transactions.delete(e),localStorage.removeItem("upload_tx_".concat(e)),console.log("Transaction ".concat(e," removed from memory"))},3e5)}processNextQueued(){if(this.activeCount>=this.maxConcurrent)return;let e=Array.from(this.transactions.values()).filter(e=>"pending"===e.state).sort((e,t)=>e.createdAt-t.createdAt);e.length>0&&(console.log("Processing next queued transaction: ".concat(e[0].id," (").concat(e.length," pending, ").concat(this.activeCount," active)")),this.processTransaction(e[0].id))}setupWebSocketListeners(){window.addEventListener("mediaUploaded",e=>{let t=e.detail;for(let e of(console.log("\uD83D\uDCE1 Received mediaUploaded event:",t),this.transactions.values())){if("finalizing"!==e.state&&"uploading"!==e.state)continue;let a=e.filename===(null==t?void 0:t.filename),n=((null==t?void 0:t.filename)||"").replace(/\.[^.]+$/,"").toLowerCase(),r=e.filename.replace(/\.[^.]+$/,"").toLowerCase(),s=r===n||r.includes(n)||n.includes(r)||e.filename.toLowerCase().includes(n);if(a||s){console.log("✅ Matched upload completion: ".concat(e.filename," -> ").concat(t.slug," (").concat(a?"exact":"fuzzy"," match)")),this.updateTransaction(e,"complete",100,"Upload complete");let n=e.completionCallback;n&&n();break}}}),window.addEventListener("uploadProgress",e=>{let{filename:t,progress:a,percent:n,stage:r}=e.detail||{},s=void 0!==a?a:n;if(void 0!==s&&t){console.log("\uD83D\uDCCA Backend upload progress: ".concat(t," ").concat(s,"% (").concat(r,")"));let e=Array.from(this.transactions.values()).filter(e=>"finalizing"===e.state);console.log("\uD83D\uDD0D Looking for match among ".concat(e.length," finalizing transactions:"),e.map(e=>"".concat(e.filename," (").concat(e.id.slice(0,8),")")));let a=!1;for(let e of this.transactions.values()){if("finalizing"!==e.state&&"uploading"!==e.state)continue;let n=e.filename===t,o=t.replace(/\.[^.]+$/,"").toLowerCase(),l=e.filename.replace(/\.[^.]+$/,"").toLowerCase(),i=l===o||l.includes(o)||o.includes(l)||e.filename.toLowerCase().includes(o);if(n||i){let o;if(console.log('✅ Found matching transaction: "'.concat(e.filename,'" vs "').concat(t,'" (').concat(n?"exact":"fuzzy"," match)")),console.log("\uD83D\uDD0D Progress mapping debug: filename=".concat(t,", backendProgress=").concat(s,', stage="').concat(r,'"')),"complete"===r)o=100,console.log("✅ Complete stage: mapped to ".concat(o,"%"));else if("finalizing"===r){let e=60+35/65*(s-20);o=Math.min(95,Math.max(60,e)),console.log("\uD83D\uDCCA Finalizing stage: ".concat(s,"% -> ").concat(e," -> ").concat(o,"% (clamped)"))}else o=Math.min(95,Math.max(60,60+35/65*(s-20))),console.log('⚠️  Unknown stage "'.concat(r,'": treating as finalizing ').concat(s,"% -> ").concat(o,"%"));console.log("\uD83C\uDFAF Updating transaction ".concat(e.id,": ").concat(e.progress,"% -> ").concat(Math.round(o),"%")),this.updateTransaction(e,"finalizing",Math.round(o),this.getStageMessage(r)||"Processing on device..."),a=!0;break}}a||console.warn('❌ No matching finalizing transaction found for "'.concat(t,'"'))}}),window.addEventListener("uploadFinalizingProgress",e=>{let{filename:t,progress:a,stage:n}=e.detail;for(let e of(console.log("\uD83D\uDCCA Upload finalizing progress: ".concat(t," ").concat(a,"% (").concat(n,")")),this.transactions.values()))if(e.filename===t&&"finalizing"===e.state){let t=60+.4*a;this.updateTransaction(e,"finalizing",t,"Processing on device...");break}})}persistTransaction(e){try{let t={...e,originalFile:void 0,zipBlob:void 0};localStorage.setItem("upload_tx_".concat(e.id),JSON.stringify(t))}catch(e){console.warn("Failed to persist transaction:",e)}}restoreTransactions(){try{for(let e=0;e<localStorage.length;e++){let t=localStorage.key(e);if(null==t?void 0:t.startsWith("upload_tx_")){let e=localStorage.getItem(t);if(e){let a=JSON.parse(e);Date.now()-a.createdAt<36e5?("complete"!==a.state&&"error"!==a.state&&(a.state="error",a.stage="interrupted"),this.transactions.set(a.id,a)):localStorage.removeItem(t)}}}}catch(e){console.warn("Failed to restore transactions:",e)}}getBasename(e){return e.replace(/\.[^.]+$/,"")}getStageMessage(e){switch(e){case"resizing":return"Optimizing video...";case"converting":case"extracting":return"Extracting frames...";case"finalizing":return"Processing on device...";case"organizing":return"Organizing files...";case"complete":return"Upload complete";default:return"Processing..."}}onProgress(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getTransaction(e){return this.transactions.get(e)}getAllTransactions(){return Array.from(this.transactions.values())}cancelUpload(e){let t=this.transactions.get(e);t&&"complete"!==t.state&&(console.log("Cancelling upload: ".concat(e)),this.updateTransaction(t,"cancelled",0,"Cancelled"),this.cleanupTransaction(e),this.activeCount=Math.max(0,this.activeCount-1),this.processNextQueued())}getStats(){let e=Array.from(this.transactions.values()).reduce((e,t)=>(e[t.state]=(e[t.state]||0)+1,e),{});return{active:this.activeCount,pending:e.pending||0,total:this.transactions.size}}constructor(){this.transactions=new Map,this.workers=new Map,this.listeners=new Set,this.maxConcurrent=2,this.activeCount=0,this.restoreTransactions(),this.setupWebSocketListeners()}}let u=new d;var f=a(6671);let g=new Map;function p(e,t,a){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(g.has(e))return;let r=f.o[t](a,{...n,onDismiss(){g.delete(e),"function"==typeof n.onDismiss&&n.onDismiss()}});g.set(e,r)}function m(e){let{onUploadComplete:t,trigger:a}=e,s=(0,r.useRef)(null);(0,r.useEffect)(()=>{a&&s.current&&s.current.click()},[a]);let o=(0,r.useCallback)(async e=>{var a;if(!(null===(a=e.target.files)||void 0===a?void 0:a.length))return;let n=Array.from(e.target.files);if(n.filter(e=>e.size>0x6400000).length){p("upload-filesize","error","Files too large. Maximum 100MB");return}for(let e of n)try{if(!u){console.error("Upload coordinator not available");continue}let t=await u.startUpload(e);console.log("\uD83D\uDE80 Started upload transaction: ".concat(t," for ").concat(e.name))}catch(t){console.error("Failed to start upload for ".concat(e.name,":"),t),p("upload-error-".concat(e.name),"error","Upload failed: ".concat(e.name))}t&&t(),e.target.value=""},[t]);return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("input",{ref:s,type:"file",multiple:!0,accept:"image/*,video/*,.gif,.mov,.m4v,.heic,.heif",onChange:o,className:"hidden"})})}a(7470),a(8266);let h=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:i("rounded-lg border bg-card text-card-foreground shadow-sm",a),...r})});h.displayName="Card";let v=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:i("flex flex-col space-y-1.5 p-6",a),...r})});v.displayName="CardHeader";let x=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:i("text-2xl font-semibold leading-none tracking-tight",a),...r})});x.displayName="CardTitle",r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:i("text-sm text-muted-foreground",a),...r})}).displayName="CardDescription";let y=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:i("p-6 pt-0",a),...r})});y.displayName="CardContent",r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,n.jsx)("div",{ref:t,className:i("flex items-center p-6 pt-0",a),...r})}).displayName="CardFooter";var b=a(2085);let w=(0,b.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function j(e){let{className:t,variant:a,...r}=e;return(0,n.jsx)("div",{className:i(w({variant:a}),t),...r})}var N=a(9708);let k=(0,b.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),C=r.forwardRef((e,t)=>{let{className:a,variant:r,size:s,asChild:o=!1,...l}=e,c=o?N.DX:"button";return(0,n.jsx)(c,{className:i(k({variant:r,size:s,className:a})),ref:t,...l})});C.displayName="Button";var S=a(6857);let T=r.forwardRef((e,t)=>{let{className:a,children:r,...s}=e;return(0,n.jsxs)(S.bL,{ref:t,className:i("relative overflow-hidden",a),...s,children:[(0,n.jsx)(S.LM,{className:"h-full w-full rounded-[inherit]",children:r}),(0,n.jsx)(U,{}),(0,n.jsx)(S.OK,{})]})});T.displayName=S.bL.displayName;let U=r.forwardRef((e,t)=>{let{className:a,orientation:r="vertical",...s}=e;return(0,n.jsx)(S.VM,{ref:t,orientation:r,className:i("flex touch-none select-none transition-colors","vertical"===r&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===r&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",a),...s,children:(0,n.jsx)(S.lr,{className:"relative flex-1 rounded-full bg-border"})})});U.displayName=S.VM.displayName;var D=a(1154),E=a(9389),F=a(2178),A=a(5690),z=a(6675),P=a(2525),M=a(4616);function L(e){let t=new Map;for(let a of e){let e=t.get(a.filename);if(!e){t.set(a.filename,a);continue}let n=e=>{switch(e){case"completed":return 3;case"processing":return 2;case"uploaded":return 1;default:return 0}};n(a.processing_status)>n(e.processing_status)&&t.set(a.filename,a)}return Array.from(t.values())}function R(e){var t,a,s,o,l;let{dashboardData:i,onCurrentlyPlayingChange:d}=e,[u,f]=(0,r.useState)([]),[g,p]=(0,r.useState)(null),[b,w]=(0,r.useState)(!1),[N,k]=(0,r.useState)([]),[S,U]=(0,r.useState)([]),[R,_]=(0,r.useState)(0),[I,O]=(0,r.useState)(!1),[B,H]=(0,r.useState)(new Map),q=(null==i?void 0:i.media)||[],W=(null==i?void 0:i.loop)||[],X=null==i?void 0:i.status,V=(null==X?void 0:null===(t=X.player)||void 0===t?void 0:t.is_playing)||!1,G=null==X?void 0:null===(a=X.player)||void 0===a?void 0:a.current_media,$=q.find(e=>e.slug===G),J=q.filter(e=>W.includes(e.slug)),Q=q.filter(e=>!W.includes(e.slug));(0,r.useEffect)(()=>{var e,t;if(!i)return;let a=L(null!==(e=i.media)&&void 0!==e?e:[]),n=(null!==(t=i.loop)&&void 0!==t?t:[]).map(e=>a.find(t=>t.slug===e)).filter(Boolean);if(k(a),U(n),i.active){let e=n.findIndex(e=>e.slug===i.active);-1!==e&&_(e)}},[i]),(0,r.useEffect)(()=>{let e=()=>{(0,c.Uk)(),(0,c.ZW)().then(e=>{var t,a;let n=L(null!==(t=e.media)&&void 0!==t?t:[]);k(n);let r=(null!==(a=e.loop)&&void 0!==a?a:[]).map(e=>n.find(t=>t.slug===e)).filter(Boolean);if(U(r),e.active){let t=r.findIndex(t=>t.slug===e.active);-1!==t&&_(t)}}).catch(console.error)};return window.addEventListener("mediaUploaded",e),()=>{window.removeEventListener("mediaUploaded",e)}},[]),(0,r.useEffect)(()=>{var e,t;if((null==i?void 0:null===(t=i.status)||void 0===t?void 0:null===(e=t.player)||void 0===e?void 0:e.is_playing)&&S.length>0){let e=setInterval(()=>{_(e=>(e+1)%S.length)},8e3);return()=>clearInterval(e)}},[null==i?void 0:null===(o=i.status)||void 0===o?void 0:null===(s=o.player)||void 0===s?void 0:s.is_playing,S.length]),(0,r.useEffect)(()=>{d(S.length>0?S[R]:null)},[S,R,d]),(0,r.useEffect)(()=>{f([])},[i]);let Z=async()=>{try{await togglePlayback()}catch(e){console.error("Failed to toggle playback:",e)}},K=async()=>{try{await nextMedia()}catch(e){console.error("Failed to skip to next:",e)}},Y=async()=>{try{await previousMedia()}catch(e){console.error("Failed to skip to previous:",e)}},ee=async e=>{try{await (0,c.w8)(e)}catch(e){console.error("Failed to delete media:",e)}},et=async e=>{try{await activateMedia(e)}catch(e){console.error("Failed to activate media:",e)}},ea=async e=>{try{await (0,c.hR)(e)}catch(e){console.error("Failed to add to loop:",e)}},en=async e=>{try{await (0,c.jq)(e)}catch(e){console.error("Failed to remove from loop:",e)}},er=(e,t)=>{e.dataTransfer.setData("text/plain",t),w(!0)},es=(e,t)=>{e.preventDefault(),p(t)},eo=()=>{p(null)},el=async(e,t)=>{e.preventDefault(),w(!1),p(null);let a=e.dataTransfer.getData("text/plain");if(a===t)return;let n=[...W],r=n.indexOf(a),s=n.indexOf(t);if(-1!==r&&-1!==s){n.splice(r,1),n.splice(s,0,a);try{await (0,c.ij)(n)}catch(e){console.error("Failed to update loop order:",e)}}},ei=()=>{w(!1),p(null)};return(S.map(e=>e.slug),S.length>0?null===(l=S[R])||void 0===l||l.slug:i.active,i)?(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 p-6 h-full",children:[(0,n.jsxs)(h,{children:[(0,n.jsx)(v,{children:(0,n.jsxs)(x,{className:"flex items-center justify-between",children:[(0,n.jsx)("span",{children:"Currently Playing"}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(C,{variant:"outline",size:"sm",onClick:Y,children:(0,n.jsx)(E.A,{className:"h-4 w-4"})}),(0,n.jsx)(C,{variant:"outline",size:"sm",onClick:Z,children:V?(0,n.jsx)(F.A,{className:"h-4 w-4"}):(0,n.jsx)(A.A,{className:"h-4 w-4"})}),(0,n.jsx)(C,{variant:"outline",size:"sm",onClick:K,children:(0,n.jsx)(z.A,{className:"h-4 w-4"})})]})]})}),(0,n.jsx)(y,{children:$?(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("div",{className:"aspect-video bg-gray-900 rounded-lg flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-gray-400",children:$.filename})}),(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h3",{className:"font-medium",children:$.filename}),(0,n.jsxs)("p",{className:"text-sm text-gray-400",children:[$.type," • ",$.frame_count," frames"]})]}),(0,n.jsx)(j,{variant:V?"default":"secondary",children:V?"Playing":"Paused"})]})]}):(0,n.jsx)("div",{className:"text-center py-8 text-gray-400",children:"No media selected"})})]}),(0,n.jsxs)(h,{children:[(0,n.jsx)(v,{children:(0,n.jsx)(x,{children:"Upload Media"})}),(0,n.jsx)(y,{children:(0,n.jsx)(m,{onUploadComplete:()=>{(0,c.Uk)()},trigger:I})})]}),(0,n.jsxs)(h,{children:[(0,n.jsx)(v,{children:(0,n.jsxs)(x,{children:["Loop Queue (",J.length,")"]})}),(0,n.jsx)(y,{children:(0,n.jsx)(T,{className:"h-64",children:J.length>0?(0,n.jsx)("div",{className:"space-y-2",children:W.map((e,t)=>{let a=q.find(t=>t.slug===e);if(!a)return null;let r=a.slug===G,s=g===e;return(0,n.jsxs)("div",{draggable:!0,onDragStart:t=>er(t,e),onDragOver:t=>es(t,e),onDragLeave:eo,onDrop:t=>el(t,e),onDragEnd:ei,className:"flex items-center justify-between p-3 rounded-lg border cursor-move transition-colors ".concat(r?"border-blue-500 bg-blue-500/10":s?"border-gray-400 bg-gray-800/50":"border-gray-700 hover:border-gray-600"),children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("span",{className:"text-sm text-gray-400 w-6",children:t+1}),(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"font-medium",children:a.filename}),(0,n.jsxs)("div",{className:"text-sm text-gray-400",children:[a.frame_count," frames"]})]})]}),(0,n.jsxs)("div",{className:"flex gap-1",children:[(0,n.jsx)(C,{variant:"ghost",size:"sm",onClick:()=>et(e),children:(0,n.jsx)(A.A,{className:"h-4 w-4"})}),(0,n.jsx)(C,{variant:"ghost",size:"sm",onClick:()=>en(e),children:(0,n.jsx)(P.A,{className:"h-4 w-4"})})]})]},e)})}):(0,n.jsx)("div",{className:"text-center py-8 text-gray-400",children:"No media in loop"})})})]}),(0,n.jsxs)(h,{children:[(0,n.jsx)(v,{children:(0,n.jsxs)(x,{children:["Media Library (",Q.length,")"]})}),(0,n.jsx)(y,{children:(0,n.jsx)(T,{className:"h-64",children:Q.length>0?(0,n.jsx)("div",{className:"space-y-2",children:Q.map(e=>(0,n.jsxs)("div",{className:"flex items-center justify-between p-3 rounded-lg border border-gray-700 hover:border-gray-600",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{className:"font-medium",children:e.filename}),(0,n.jsxs)("div",{className:"text-sm text-gray-400",children:[e.type," • ",e.frame_count," frames"]})]}),(0,n.jsxs)("div",{className:"flex gap-1",children:[(0,n.jsx)(C,{variant:"ghost",size:"sm",onClick:()=>et(e.slug),children:(0,n.jsx)(A.A,{className:"h-4 w-4"})}),(0,n.jsx)(C,{variant:"ghost",size:"sm",onClick:()=>ea(e.slug),children:(0,n.jsx)(M.A,{className:"h-4 w-4"})}),(0,n.jsx)(C,{variant:"ghost",size:"sm",onClick:()=>ee(e.slug),children:(0,n.jsx)(P.A,{className:"h-4 w-4"})})]})]},e.slug))}):(0,n.jsx)("div",{className:"text-center py-8 text-gray-400",children:"All media is in the loop"})})})]})]}):(0,n.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(D.A,{className:"h-4 w-4 animate-spin"}),(0,n.jsx)("span",{children:"Loading dashboard..."})]})})}var _=a(9028);let I=r.forwardRef((e,t)=>{let{className:a,...r}=e;return(0,n.jsx)(_.bL,{className:i("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",a),...r,ref:t,children:(0,n.jsx)(_.zi,{className:i("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})})});function O(e){var t,a,r;let{status:s,currentlyPlaying:o}=e,l=async()=>{try{await (0,c.sd)()}catch(e){p("playback-toggle-fail","error","Failed to toggle playback")}},i=async()=>{try{await (0,c.S)()}catch(e){p("loopmode-fail","error","Failed to toggle loop mode")}};return(0,n.jsx)("div",{className:"fixed bottom-0 left-0 right-0 z-50 bg-black border-t border-gray-800",children:(0,n.jsx)("div",{className:"mx-auto max-w-6xl px-8 py-4",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4 flex-1 min-w-0",children:[(0,n.jsx)("div",{className:"w-12 h-12 rounded-lg overflow-hidden bg-gray-800 flex-shrink-0",children:(null==o?void 0:o.url)&&o.type.startsWith("image/")?(0,n.jsx)("img",{src:o.url||"/placeholder.svg",alt:o.filename,className:"w-full h-full object-cover"}):(0,n.jsx)("div",{className:"w-full h-full flex items-center justify-center",children:(0,n.jsx)("div",{className:"text-xs text-gray-500",children:"□"})})}),(0,n.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,n.jsx)("div",{className:"text-white text-sm font-medium truncate",children:o?o.filename:"No media in loop"}),(0,n.jsx)("div",{className:"text-gray-400 text-xs",children:o?"Now Playing":"Add media to start"})]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-6 flex-shrink-0",children:[(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("span",{className:"text-xs text-gray-400",children:(null==s?void 0:null===(t=s.player)||void 0===t?void 0:t.loop_mode)==="all"?"Loop All":"Loop One"}),(0,n.jsx)(I,{checked:(null==s?void 0:null===(a=s.player)||void 0===a?void 0:a.loop_mode)==="all",onCheckedChange:i,className:"data-[state=checked]:bg-green-400 data-[state=unchecked]:bg-gray-600"})]}),(0,n.jsx)("button",{onClick:l,className:"h-10 w-10 rounded-full bg-white text-black hover:bg-gray-100 transition-colors flex items-center justify-center",children:(0,n.jsx)("span",{className:"text-lg",children:(null==s?void 0:null===(r=s.player)||void 0===r?void 0:r.is_playing)?"⏸":"▶"})})]})]})})})}function B(e){let{connectionState:t}=e;return(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(()=>{switch(t){case"connecting":return(0,n.jsx)("div",{className:"h-2 w-2 rounded-full bg-yellow-400 animate-pulse"});case"connected":return(0,n.jsx)("div",{className:"h-2 w-2 rounded-full bg-green-400"});case"disconnected":default:return(0,n.jsx)("div",{className:"h-2 w-2 rounded-full bg-gray-400"});case"error":return(0,n.jsx)("div",{className:"h-2 w-2 rounded-full bg-red-400 animate-pulse"})}})(),(0,n.jsx)("span",{className:"text-sm text-muted-foreground",children:(()=>{switch(t){case"connecting":return"Re-connecting…";case"connected":return"Connected";case"disconnected":return"Offline";case"error":return"Connection Lost";default:return"Unknown"}})()})]})}I.displayName=_.bL.displayName;var H=a(646),q=a(1788);function W(){let[e]=(0,r.useState)("1.0.0"),[t,a]=(0,r.useState)(null),[s,o]=(0,r.useState)(!1),[l,i]=(0,r.useState)(!1),d=async()=>{o(!0);try{(await (0,c.Ux)()).updates_available.git?(a("Available"),p("update-avail","success","Git update available")):p("update-none","info","System is up to date")}catch(e){p("update-check-fail","error","Failed to check for updates")}finally{o(!1)}},u=async()=>{if(t){i(!0);try{await (0,c.Px)(),p("update-installed","success","Update installed - device will restart"),a(null)}catch(e){p("update-install-fail","error","Failed to install update")}finally{i(!1)}}};return(0,n.jsxs)("div",{className:"rounded-3xl bg-card p-8 space-y-4",children:[(0,n.jsx)("h3",{className:"text-xl font-semibold mb-8",children:"System & Updates"}),(0,n.jsxs)("div",{className:"flex items-center justify-between p-3 bg-muted rounded-lg",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(H.A,{className:"h-5 w-5 text-green-500"}),(0,n.jsx)("span",{className:"font-medium",children:"Current Version"})]}),(0,n.jsx)(j,{variant:"outline",children:e})]}),t&&(0,n.jsxs)("div",{className:"flex items-center justify-between p-3 bg-primary/5 border border-primary/20 rounded-lg",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(q.A,{className:"h-5 w-5 text-primary"}),(0,n.jsx)("span",{className:"font-medium",children:"Update Available"})]}),(0,n.jsx)(j,{children:t})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(C,{onClick:d,disabled:s,variant:"outline",children:s?"Checking...":"Check for Updates"}),(0,n.jsx)(C,{onClick:u,disabled:!t||l,children:l?"Installing...":"Install Update"})]}),t&&(0,n.jsxs)("div",{className:"text-sm text-muted-foreground p-3 bg-muted rounded-lg",children:[(0,n.jsx)("strong",{children:"Note:"})," The device will automatically restart after the update is installed. Make sure no critical operations are running."]})]})}function X(){var e,t,a,s;let{data:o,isConnected:l,connectionState:i,error:d}=function(){let[e,t]=(0,r.useState)(null),[a,n]=(0,r.useState)("disconnected"),[s,o]=(0,r.useState)(null),[l,i]=(0,r.useState)(null),d=(0,r.useRef)(null),u=(0,r.useRef)(null),f=(0,r.useRef)(!0),g=(0,r.useRef)(0),p=(0,r.useCallback)(()=>l&&l.progress<100?2e3:8e3,[l]),m=(0,r.useCallback)(async()=>{if(f.current)try{n("connecting");let e=await (0,c.ZW)({signal:AbortSignal.timeout(1e4)});if(!f.current)return;t(e),n("connected"),o(null),g.current=Date.now()}catch(t){var e,a;if(!f.current)return;console.error("Dashboard polling error:",t),(null===(e=t.name)||void 0===e?void 0:e.includes("Abort"))||(null===(a=t.message)||void 0===a?void 0:a.includes("timeout"))||(n("disconnected"),o(t))}},[]),h=(0,r.useCallback)(async()=>{if(f.current)try{let e=await (0,c.eB)();if(!f.current)return;let t=e.active_jobs,a=Object.keys(t);if(a.length>0){let e=t[a[0]];i({filename:e.filename,progress:e.progress,status:e.stage}),window.dispatchEvent(new CustomEvent("uploadProgress",{detail:{filename:e.filename,progress:e.progress,percent:e.progress,stage:e.stage}}))}else l&&i(null)}catch(e){if(!f.current)return;console.warn("Progress polling error:",e)}},[l]);return(0,r.useEffect)(()=>{let e=e=>{console.log("✅ Media uploaded, refreshing dashboard:",e.detail),m(),t(t=>{let a;if(!t)return t;let n=e.detail,r=t.media.findIndex(e=>e.slug===(null==n?void 0:n.slug));return r>=0?(a=[...t.media])[r]=n:a=[...t.media,n],{...t,media:a}})};return window.addEventListener("mediaUploaded",e),()=>window.removeEventListener("mediaUploaded",e)},[m]),(0,r.useEffect)(()=>(f.current=!0,m(),d.current&&clearInterval(d.current),d.current=setInterval(()=>{m()},p()),u.current=setInterval(()=>{h()},3e3),()=>{f.current=!1,d.current&&clearInterval(d.current),u.current&&clearInterval(u.current)}),[m,p,h]),(0,r.useEffect)(()=>{"connected"===a&&d.current&&(clearInterval(d.current),d.current=setInterval(()=>{m()},p()))},[p,m,a]),{data:e,error:s,connectionState:a,uploadProgress:l,isConnected:"connected"===a,isConnecting:"connecting"===a}}();return(0,n.jsxs)("div",{className:"flex flex-col min-h-screen bg-black text-white relative",children:[(0,n.jsx)("header",{className:"p-4 border-b border-gray-800",children:(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold",children:"LOOP"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(W,{}),(0,n.jsx)(B,{connectionState:i})]})]})}),(0,n.jsx)("main",{className:"flex-1 overflow-hidden",children:o?(0,n.jsx)(R,{dashboardData:o}):(0,n.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("div",{className:"animate-spin h-4 w-4 border-2 border-gray-400 border-t-transparent rounded-full"}),(0,n.jsx)("span",{children:"Loading dashboard..."})]})})}),(0,n.jsx)(O,{status:null!==(a=null==o?void 0:o.status)&&void 0!==a?a:null,currentlyPlaying:(null==o?void 0:null===(t=o.status)||void 0===t?void 0:null===(e=t.player)||void 0===e?void 0:e.current_media)&&null!==(s=o.media.find(e=>e.slug===o.status.player.current_media))&&void 0!==s?s:null})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[671,223,441,684,358],()=>t(2857)),_N_E=e.O()}]);